<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"/>
		<title>3d test</title>
		<script type="text/javascript">
			'use strict';

			const PICTURE_SIZE = 900;

			function main() {
				readTextFile("african_head.obj", (file) => draw(parseObj(file)));
			}
			
			function parseObj(raw) {
				const v = [];
				const f = [];
				const vt = [];
				const vn = [];
				const file = raw.split(/\n/);
				for (let i = 0; i < file.length; i++) {
					switch (file[i].substr(0, 2)) {
						case 'v ':
							v.push(file[i].substr(2).split(' '));
							break;
						case 'f ':
							const face = file[i].substr(2).split(' ');
							const faceArr = [];
							for (let i = 0; i < 3; i++) {
								faceArr.push(face[i].split('/'));
							}
							f.push(faceArr);
							break;
					}
				}
				return [v, f];
			}
			
			function readTextFile(file, callback)
			{
				const rawFile = new XMLHttpRequest();
				rawFile.open("GET", file);
				rawFile.onreadystatechange = () => {
					if (rawFile.readyState === 4) {
						if (rawFile.status === 200 || rawFile.status == 0) {
							callback(rawFile.responseText);
						}
					}
				}
				rawFile.send(null);
			}

			class Vector {

				constructor (x, y, z) {
					this.x = x;
					this.y = y;
					this.z = z;
				}

				static fromArray (arr) {
					return new Vector(arr[0], arr[1], arr[2]);
				}
			
				cross(v) {
					return new Vector(
						this.y * v.z - this.z * v.y,
						this.x * v.z - this.z * v.x,
						this.x * v.y - this.y * v.x
					);
				}

				minus(v) {
					return new Vector(
						this.x - v.x,
						this.y - v.y,
						this.z - v.z
					)
				}

				dotProduct(v) {
					return (
						this.x * v.x + 
						this.y * v.y + 
						this.z * v.z
					);
				}

				length() {
					return Math.sqrt(
						this.x * this.x + 
						this.y * this.y + 
						this.z * this.z
					);
				}

				normalize() {
					const invLength = 1 / this.length();
					this.x *= invLength;
					this.y *= invLength;
					this.z *= invLength;
					return this;
				}
			}
			
			function draw(file) {
				const a = performance.now();
				const canvas = document.getElementById('test');
				if (canvas.getContext) {
					const ctx = canvas.getContext('2d');
					ctx.fillStyle = "#000";
					ctx.fillRect(0,0, PICTURE_SIZE, PICTURE_SIZE);
					ctx.translate(0, canvas.height);
					ctx.scale(1, -1);
					
					const draw = (x, y, color) => {
						ctx.fillStyle = 
							"rgba("+color[0]+","+color[1]+","+color[2]+", "+(color[3]/255)+")";
						ctx.fillRect(Math.floor(x + + 0.00000000000001), Math.floor(y + + 0.00000000000001), 1, 1);
					}
					
					const line = (x0, y0, x1, y1, color) => {
						let steep = false;
						if (Math.abs(x0-x1) < Math.abs(y0-y1)) {
							[x0, y0] = [y0, x0];
							[x1, y1] = [y1, x1];
							steep = true;
						}
						if (x0 > x1) {
							[x0, x1] = [x1, x0];
							[y0, y1] = [y1, y0];
						}
						const dx = x1 - x0;
						const dy = y1 - y0;
						const derror = Math.abs(dy)*2;
						let error = 0;
						let y = y0;
						for (let x = x0; x <= x1; x++) {
							if (steep) {
								draw(y, x, color);
							} else {
								draw(x, y, color);
							}
							error += derror;
							if (error > dx) {
								y += (y1 > y0 ? 1 : -1);
								error -= dx*2;
							}
						}
					}

					const triangle = (x0, y0, x1, y1, x2, y2, color) => {
						x0 = Math.floor(x0);
						y0 = Math.floor(y0);
						x1 = Math.floor(x1);
						y1 = Math.floor(y1);
						x2 = Math.floor(x2);
						y2 = Math.floor(y2);
						if (y0 > y1) {
							[x0, y0, x1, y1] = [x1, y1, x0, y0];
						}
						if (y0 > y2) {
							[x0, y0, x2, y2] = [x2, y2, x0, y0];
						}
						if (y1 > y2) {
							[x1, y1, x2, y2] = [x2, y2, x1, y1];
						}
						const height = y2 - y0;
						let currentHeight = y1 - y0 + 1;
						for (let y = y0; y <= y1; y++) {
							const alpha = (y - y0) / height;
							const beta  = (y - y0) / currentHeight;
							let xl = Math.floor(x0 + (x2 - x0) * alpha + 0.00000000000001);
							let xr = Math.floor(x0 + (x1 - x0) * beta + 0.00000000000001);	
							if (xl > xr) {
								[xl, xr] = [xr, xl];
							}
							for (let x = xl; x <= xr; x++) {
								draw(x, y, color);
							}
						}
						currentHeight = y2 - y1 + 1;
						for (let y = y1; y <= y2; y++) {
							const alpha = (y-y0) / height;
							const beta  = (y-y1) / currentHeight;
							let xl = Math.floor(x0 + (x2 - x0) * alpha + 0.00000000000001);
							let xr = Math.floor(x1 + (x2 - x1) * beta + 0.00000000000001);	
							if (xl > xr) {
								[xl, xr] = [xr, xl];
							}
							for (let x = xl; x <= xr; x++) {
								draw(x, y, color);
							}
							
						}
						// line(x0, y0, x1, y1, color);
						// line(x1, y1, x2, y2, color);
						// line(x0, y0, x2, y2, color);
					}
					
					const white = [255, 255, 255, 255];
					const red = [255, 0, 0, 255];
					const green = [0, 255, 0, 255];

					const one = [255,255,255,255];
					const two = [200,200,200,255];
					
					const [v, f] = file;
					const lightDir = new Vector(0, -1, -1);
					
					for (let i = 0; i < f.length; i++) {
					//for (let i = 0; i < 0; i++) {
						const v0 = new Vector(
							(parseFloat(v[f[i][0][0] - 1][0]) + 1) * (PICTURE_SIZE/2),
							(parseFloat(v[f[i][0][0] - 1][1]) + 1) * (PICTURE_SIZE/2),
							(parseFloat(v[f[i][0][0] - 1][2]) + 1) * (PICTURE_SIZE/2)
						);
						const v1 = new Vector(
							(parseFloat(v[f[i][1][0] - 1][0]) + 1) * (PICTURE_SIZE/2),
							(parseFloat(v[f[i][1][0] - 1][1]) + 1) * (PICTURE_SIZE/2),
							(parseFloat(v[f[i][1][0] - 1][2]) + 1) * (PICTURE_SIZE/2)
						);
						const v2 = new Vector(
							(parseFloat(v[f[i][2][0] - 1][0]) + 1) * (PICTURE_SIZE/2),
							(parseFloat(v[f[i][2][0] - 1][1]) + 1) * (PICTURE_SIZE/2),
							(parseFloat(v[f[i][2][0] - 1][2]) + 1) * (PICTURE_SIZE/2)
						);
						const first = v2.minus(v0);
						const second = v1.minus(v0);
						const c = first.cross(second);
						c.normalize();
						const intensity = c.dotProduct(lightDir);
						//console.log(v0.x, v0.y, v1.x, v1.y, v2.x, v2.y, [Math.round(intensity*255), Math.round(intensity*255), Math.round(intensity*255), 255])
						if (intensity > 0) {
							triangle(v0.x, v0.y, v1.x, v1.y, v2.x, v2.y, [Math.round(intensity*255), Math.round(intensity*255), Math.round(intensity*255), 255]);
						}
					}
				}
				const b = performance.now();
				console.log((b - a) + ' ms.');
			}

		</script>
		<style type="text/css">
			canvas {border: 1px solid black;}
		</style>
	</head>
	<body onload="main();">
		<canvas id="test" width="900" height="900"></canvas>
	</body>
</html>