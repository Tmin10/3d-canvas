<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"/>
		<title>3d test</title>
		<script type="text/javascript">
			function main() {
				readTextFile("african_head.obj", (file) => draw(parseObj(file)));
			}
			
			function parseObj(raw) {
				const v = [];
				const f = [];
				const vt = [];
				const vn = [];
				const file = raw.split(/\n/);
				for (let i = 0; i < file.length; i++) {
					switch (file[i].substr(0, 2)) {
						case 'v ':
							v.push(file[i].substr(2).split(' '));
							break;
						case 'f ':
							const face = file[i].substr(2).split(' ');
							const faceArr = [];
							for (let i = 0; i < 3; i++) {
								faceArr.push(face[i].split('/'));
							}
							f.push(faceArr);
							break;
					}
				}
				return [v, f];
			}
			
			function readTextFile(file, callback)
			{
				const rawFile = new XMLHttpRequest();
				rawFile.open("GET", file);
				rawFile.onreadystatechange = () => {
					if (rawFile.readyState === 4) {
						if (rawFile.status === 200 || rawFile.status == 0) {
							callback(rawFile.responseText);
						}
					}
				}
				rawFile.send(null);
			}
			
			function draw(file) {
				const a = performance.now();
				const canvas = document.getElementById('test');
				if (canvas.getContext) {
					const ctx = canvas.getContext('2d');
					ctx.fillStyle = "#000";
					ctx.fillRect(0,0, 1000, 1000);
					ctx.translate(0, canvas.height);
					ctx.scale(1, -1);
					
					const draw = (x, y, color) => {
						ctx.fillStyle = 
							"rgba("+color[0]+","+color[1]+","+color[2]+","+(color[3]/255)+")";
						ctx.fillRect(x, y, 1, 1 );
					}
					
					const line = (x0, y0, x1, y1, color) => {
						let steep = false;
						if (Math.abs(x0-x1) < Math.abs(y0-y1)) {
							[x0, y0] = [y0, x0];
							[x1, y1] = [y1, x1];
							steep = true;
						}
						if (x0 > x1) {
							[x0, x1] = [x1, x0];
							[y0, y1] = [y1, y0];
						}
						const dx = x1 - x0;
						const dy = y1 - y0;
						const derror = Math.abs(dy)*2;
						let error = 0;
						let y = y0;
						for (let x = x0; x <= x1; x++) {
							if (steep) {
								draw(y, x, color);
							} else {
								draw(x, y, color);
							}
							error += derror;
							if (error > dx) {
								y += (y1 > y0 ? 1 : -1);
								error -= dx*2;
							}
						}
					}
					
					const white = [255, 255, 255, 255];
					const red = [255, 0, 0, 255];
					const green = [0, 255, 0, 255];
					
					const [v, f] = file;
					for (let i = 0; i < f.length; i++) {
						for (let j = 0; j < 3; j++) {
							line(
								(parseFloat(v[f[i][j][0] - 1][0]) + 1) * (1000/2),
								(parseFloat(v[f[i][j][0] - 1][1]) + 1) * (1000/2),
								(parseFloat(v[f[i][(j+1)%3][0] - 1][0]) + 1) * (1000/2),
								(parseFloat(v[f[i][(j+1)%3][0] - 1][1]) + 1) * (1000/2),
								white
							);
						}
					}
					
				}
				const b = performance.now();
				console.log((b - a) + ' ms.');
			}

		</script>
		<style type="text/css">
			canvas {border: 1px solid black;}
		</style>
	</head>
	<body onload="main();">
		<canvas id="test" width="1000" height="1000"></canvas>
	</body>
</html>